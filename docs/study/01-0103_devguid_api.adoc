=== Amazon DynamoDBのAPI
// [cols=2*,options="header",cols="25,75"]

==== APIの種類
* カテゴリ
** コントロールプレーン：DynamoDB テーブルを作成および管理できます。また、インデックス、ストリーム、およびテーブルに依存する他のオブジェクトを操作できます。
** データプレーン：テーブルのデータで、作成、読み込み、更新、および削除 (CRUD とも呼ばれる) アクションを実行できます。2種類のAPIが容易されている。
*** PartiQL API： SQL 互換のクエリ言語である PartiQL をサポートするAPI
*** Classic API：各オペレーションを個別の API コールに分離する DynamoDB の従来の CRUD API
** DynamoDB Stream：テーブルのストリーミングを有効または無効にし、ストリーミングに含まれるデータ変更レコードにアクセスするように許可します。
** トランザクション：トランザクションによって不可分性、一貫性、分離性、耐久性 (ACID) が実現されるため、アプリケーション内でのデータの精度を維持することがさらに容易になります

==== コントロールプレーン API
[cols=3*,options="header",cols="20,20,60a"]
|===
| API | 処理内容 | 補足 
| CreateTable | テーブルの新規作成 | * 1つ以上のセカンダリインデックスの作成可能 + 
* 読み取り／書き込みキャパシティモードとしてオンデマンドモードとプロビジョニングモードを利用可能 + 
* テーブルクラスとしてstandard（デフォルト）とstandard-IAを選択可能 + 
* テーブルに対して DynamoDB Streams を有効にできる
| DescribeTable | テーブルに関する情報の取得 | プライマリキーのスキーマスループット設定、セカンダリインデックス情報など
| ListTables | すべてのテーブル名の取得 | －
| UpdateTable | テーブルの更新 | * テーブルまたはそのセカンダリインデックスの設定を変更可能 + 
* 読み取り/書き込みキャパシティーモードの変更
* （プロビジョニングモード時の）スループット設定の変更
* 新しいインデックスを作成または削除可能 + 
* テーブルの DynamoDB Streams 設定変更可能
| DeleteTable | テーブルの削除 | * テーブルとそのすべての依存オブジェクトを DynamoDB から削除
* 削除保護を設定していた場合削除不可
* テーブルの削除は回復不可能な操作
|===

==== テーブルの項目に対する操作API（データプレーン API と トランザクション API）
[cols="10,5,5,15,5,5,10,20a"]

|===
.2+| 特徴 
.2+| Classic API 
.2+| PartiQL 
.2+| 処理内容 
2+| キャパシティユニット 
.2+| PK指定 
.2+| 補足 
| 書込 | 読込

.4+| 単一項目操作 
| PutItem | ExecuteStatement INSERT | 単一項目の作成、既存のキー値指定の場合は新しい項目に置き換え | ○ | － | 必須 | * 条件付き書き込み可能[※1]
| GetItem | ExecuteStatement SELECT | 単一項目の取得 | － | ○ | 必須 | * 結果整合性または強い整合性のどちらか選択可能 
| UpdateItem | ExecuteStatement UPDATE | 単一項目の更新 | ○ | － | 必須 | * 条件付き書き込み可能[※1] + 
* アトミックカウンター利用可能[※2]
| DeleteItem | ExecuteStatement DELETE | 単一項目の削除 | ○ | － | 必須 | * 条件付き書き込み可能[※1]

.3+| 複数項目の検索 
| BatchGetItem | BatchExecuteStatement SELECT | 複数項目の取得 | － | ○ | 各項目別に必須 
| * GetItemをまとめて実行するイメージ + 
* １つのバッチ処理で複数テーブルに対して処理可能 + 
* 処理結果は個別に応答される + 
* 最大処理項目数：100
* 最大 16 MB のデータの取得可能

| Query | ExecuteStatement SELECT | テーブルの特定パーティションキーの全項目の取得 | － | ○ | パーティションキー必須 
|
* ソートキーに対する抽出条件による絞り込み可能[※3] + 
* フィルタリング条件指定による取捨選択可能[※4] + 
* セカンダリインデックスに対しても実行可能
* 結果整合性または強い整合性のどちらか選択可能
* 最大 1 MB のデータ（それ以上のデータを読み込みたい場合はページ分割読み込みを行う）

| Scan | ExecuteStatement SELECT | テーブルの全項目の取得 | － | ○ | 不要 
| * フィルタリング条件指定による取捨選択可能[※4]  + 
* セカンダリインデックスに対しても実行可能
* 結果整合性または強い整合性のどちらか選択可能 
* 最大 1 MB のデータを取得（それ以上のデータを読み込みたい場合はページ分割読み込みを行う）

| 複数項目の生成 or 削除 + 
（トランザクション無し）
| BatchWriteItem | BatchExecuteStatement INSERT or DELETE | 複数項目の作成 or 削除 | ○ | － | 各項目別に必須 
| * 単一項目操作（PutItem or DeleteItem）をまとめて実行するイメージ + 
* 処理結果は項目別に返却される（一部成功、一部失敗が発生する） + 
* １つのバッチ処理で複数テーブルに対して処理可能だが、作成処理と削除処理を同時に実施することはできない + 
* 最大処理項目数：25
* 最大 16 MB のデータの書き込み可能（個々の項目書き込み最大400KB）

.2+| 複数項目操作 + 
（トランザクション）
| TransactGetItems  | ExecuteTransaction SELECT  |  1つ以上のテーブルからの複数項目取得  | － | ○ | 各項目別に必須 
| * 単一項目操作（GetItem）をまとめて実行するイメージ + 
* 最大処理項目数：100
* 一部の処理に失敗した場合、すべての処理がロールバックされる
* トランザクション内のアイテムの合計サイズは 4 MB を超えることはできない
* DynamoDB アクセラレーター (DAX) でサポート

| TransactWriteItems  | ExecuteTransaction INSERT or UPDATE or DELETE  | オール・オア・ナッシングの結果が保証された複数項目変更（作成 or 更新 or 削除） | ○ | － | 各項目別に必須 
| * 単一項目操作（PutItem or UpdateItem or DeleteItem or ConditionCheck(存在チェック)）をまとめて実行するイメージ + 
* 最大処理項目数：100 + 
* 一部の処理に失敗した場合、すべての処理がロールバックされる + 
* １つの項目に対して複数の操作は実施できない（ConditionCheck後にUpdateなど） + 
* トランザクション内のアイテムの合計サイズは 4 MB を超えることはできない + 
* べき等性確認のためのクライアントトークン利用可能（リクエスト処理後10分）[※5] + 
* DynamoDB アクセラレーター (DAX) でサポート + 
* 処理が競合した場合（同一項目に対する更新処理の実行があった場合）、エラーになる

|===
[※1]:: 条件付き書き込みは、ユーザ定義の条件を満たす場合のみ更新が成功するようにできる（`ConditionExpression`）
[※3]:: Query実行時のソートキーを対象とした抽出条件(`KeyConditionExpression`)の条件式としては以下を利用可能
* a = b — 属性 a が値 b と等しい場合、true
* a < b — a が b 未満の場合、true
* a <= b — a が b 以下である場合、true
* a > b — a が b より大きい場合、true
* a >= b — a が b 以上である場合、true
* a BETWEEN b AND c — a が b 以上で、c 以下である場合、true。

[※2]:: アトミックカウンターは、他の書き込みリクエストに干渉することなく無条件に増分される数値属性（べき等性[※5]は担保されず、複数回の読み出しでカウントアップorダウンする） 

[※4]:: フィルタリング条件（`FilterExpression`）による取捨選択を行う場合、テーブルの対象となる項目を取得した後のフィルター処理による取捨選択なので取得した項目分の料金が請求される + 
また、テーブルが大きい場合、読み込みキャパシティユニットの大量消費による処理遅延が発生する可能性がある
[※5]:: べき等性（冪等性）は、何回実行しても実行結果が同じ状態になること

==== DynamoDB Streams API
[cols=3*,options="header",cols="20,40,40"]
|===
| API | 処理内容 | 補足 
| ListStreams | すべてのストリーミングのリスト、または特定のテーブルのストリーミングのみを返す | － 
| DescribeStream | ストリーミングに関する情報を返す | Amazon リソースネーム (ARN) など
| GetShardIterator | シャードイテレーターを返す | ストリーミングからレコードを取得するためにアプリケーションが使用するデータ構造です
| GetRecords | 特定のシャードイテレーターを使用して 1 つ以上のストリーミングレコードを取得する | －
|===

