=== DynamoDBにおける設計の考え方

==== 設計おけるDynamoDBと一般的なRDBの違い
[cols="4", options="headers", cols="10,30a,30a,10"]
|===
| データベース | DynamoDB | 一般的なRDB | 補足
| 設計のベース | アクセスパターン +
 （ユーザが必要とするデータパターン） | データモデル（正規化） | －
| 設計時の思想 | 必要なデータパターンをそのまま格納・そのまま取得、大量トランザクションを高速に処理可能に | 重複を排除した最小データの格納（正規化）と必要なデータパターンに合わせて加工（テーブル結合・集計等）したデータの取得 | －
| 最も重要視するパフォーマンス | コンピューティング最適 | ストレージ最適 | －
| 特徴
| * 処理が早い（格納済みのデータパターンのデータを取得する場合）
* 大量のトラフィックの処理が可能（並列スケール可能）
* DBに上手く格納されていないデータパターンのデータの取得はほぼできない（大変コストがかかる）
* 取得時にデータを加工（テーブル結合・集計等）することはできない 
* トランザクションは1データ1更新の組み合わせを1回のリクエストで大量に同時実施する（DBへの複数のリクエストをまたぐ長時間のトランザクションは存在しない）
| * 処理が遅い（一般的にNoSQLと比べて）
* 大量のトラフィックの処理には高性能なハード投資が必要となる（垂直スケール可能）
* 複雑なデータパターンでも、データ取得時のクエリの工夫で取得可能
* トランザクションは、アプリケーション処理とDB処理を相互に実施するような長時間に及ぶ処理も実施可能
| －

| 主な設計対象 | データ格納時の値の格納方法（スキーマ設計）、キー設計 | 事前のスキーマ定義・参照整合性制約の関連などのテーブル設計 | － 

| 最適なテーブル数 | アプリケーションでできるだけ少なく（理想は1個） | 正規化された意味のあるデータ毎に１つ | －

| 最適なワークロード 
| * ソーシャルネットワーク
* ゲーム
* メディア共有
* Internet of Things (IoT) を含む
* ウェブスケールアプリケーション 
| * アドホッククエリ
* データウェアハウス
* OLAP (オンライン分析処理)
| －

|===

==== DynamoDBの設計/利用時のポイント
NOTE:: [※]はAWSデベロッパーガイドのベストプラックティスで紹介あり（イメージ後述） + 
（コスト最適化やセキュリティなどは一旦範囲外として、データベース設計に限定）

[cols="4", options="headers", cols="10a,10a,30a,30a"]
|===
2+| 対象 | 役割・注意点 | 補足

2+| テーブル 
| * アクセスパターンに合わせてデータを格納 + 
* 主に更新処理を行う際に利用 
| 大量データの更新処理時はパーティションを効率的に使えるように処理順を考慮する[※1]
.2+| プライマリキー設計 
| パーティションキー 
| * 【超重要】対象が適切に指定出来て、かつ、パーティションが適切に分割するように設計する[※2]
| アプリケーションで同時処理される可能性のあるデータ同士が異なるパーティションになる
| ソートキー 
| * アプリケーションで同時に処理される可能性のあるデータがソート順で並ぶようにする 
* 特定パーティション内の検索項目として利用できるので、アクセスパターンで抽出したい処理がある場合にうまく抽出できるような値を設定する[※3]
* バージョンコントロールに利用する目的でソートキーにバージョン番号を追加する[※3]
| －

2+| グローバルセカンダリインデックス設計（GSI）
| * 【超重要】主に複数データの検索処理を行う際に利用
** 基本テーブルに対する更新と参照処理を分離する目的で、レプリカ[※4]として基本テーブルと同一のGSIを作成し利用することもある
* アクセスパターンを実現するための最適なGSIのプライマリキーの設計が重要（各キー設計の注意点はプライマリキーと同様）
* スパースインデックス[※5]を利用して、操作対象のデータ量を最小化し処理性能の向上を図る 
* 多重定義[※6]を意識した設計により、1つのGSIで様々なのデータの取得操作を提供できるようにする
* 多対多の関連を持つデータ構造に対して、基本テーブルのパーティションキーとソートキーを逆に持つGSIを持つことで表現できる（隣接関係のリスト）[※7]

| 強力な整合性のある検索は実施できない

2+| ローカルセカンダリインデックス設計（LSI）
| * 同一パーティションで異なるソートキーで並び替えて処理したい場合の検索処理で利用
| 強力な整合性のある検索も可能、ただし、キャパシティユニットをテーブルと共有するため、並列処理には向かない可能性あり

2+| Amazon DynamoDB Streams + Lambda設計
| * 集計の結果を格納・計算したい場合に利用[※8]
| 多少の遅延があっても問題ない場合に利用可能
|===

==== DynamoDBのベストプラックティス
NOTE:: コスト最適化やセキュリティなどは一旦範囲外として、データベース設計・使い方に限定

[※1]（大量データ更新）パーティションを効率的に使える処理順イメージ ::

[※2]（パーティションキー）パーティションキー設計イメージ:: （作成中）

[※3]（ソートキー）絞り込みでの活用とバージョンコントロールを活用するイメージ:: （作成中）

[※4]（テーブルとGSI）GSIのレプリカで更新処理と参照処理の分離:: （作成中）

[※5]（GSI）スパースインデックスを利用した処理性能向上のイメージ:: （作成中）

[※6]（GSI）多重定義のイメージ:: （作成中）

[※7]（GSI）多対多のデータ構造に対する隣接関係のリストのイメージ:: （作成中）

[※8]（集計処理）Amazon DynamoDB Streams + Lambda を利用した集計処理:: （作成中）

==== DynamoDB の Well-Architected レンズ
（確認中）